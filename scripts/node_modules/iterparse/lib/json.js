"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.jsonWrite = exports.jsonRead = void 0;
const tslib_1 = require("tslib");
const helpers_1 = require("./_internal/helpers");
const base_1 = require("./base");
const events_1 = require("events");
const JSONStream = require('JSONStream');
function _jsonIterParser(stream, pattern) {
    return tslib_1.__asyncGenerator(this, arguments, function* _jsonIterParser_1() {
        const parser = JSONStream.parse(pattern);
        stream.pipe(parser);
        let data = [];
        let done = false;
        parser.on(`data`, (obj) => {
            data.push(obj);
            if (data.length > 10) {
                stream.pause();
            }
        });
        stream.on('close', () => {
            done = true;
        });
        stream.on('end', () => {
            done = true;
        });
        stream.on('error', (err) => {
            throw err;
        });
        while (!done || data.length > 0) {
            const d = data.shift();
            if (!d) {
                yield tslib_1.__await(helpers_1.delay(0));
                stream.resume();
                continue;
            }
            yield yield tslib_1.__await(d);
        }
    });
}
function jsonRead(source, options) {
    return base_1.IX.from(_jsonIterParser(base_1.sourceToReadStream(source), options.pattern));
}
exports.jsonRead = jsonRead;
function _jsonIterWriter(output, stream) {
    return tslib_1.__asyncGenerator(this, arguments, function* _jsonIterWriter_1() {
        var e_1, _a;
        let x = 0;
        let dest = null;
        let loaded = false;
        try {
            for (var stream_1 = tslib_1.__asyncValues(stream), stream_1_1; stream_1_1 = yield tslib_1.__await(stream_1.next()), !stream_1_1.done;) {
                const data = stream_1_1.value;
                if (!loaded) {
                    loaded = true;
                    dest = yield tslib_1.__await(output());
                }
                if (x === 0) {
                    dest === null || dest === void 0 ? void 0 : dest.write("[\r\n");
                    dest === null || dest === void 0 ? void 0 : dest.write(JSON.stringify(data));
                    x++;
                    yield yield tslib_1.__await(data);
                    continue;
                }
                dest === null || dest === void 0 ? void 0 : dest.write(`\r\n,${JSON.stringify(data)}`);
                yield yield tslib_1.__await(data);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (stream_1_1 && !stream_1_1.done && (_a = stream_1.return)) yield tslib_1.__await(_a.call(stream_1));
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (x === 0) {
            dest === null || dest === void 0 ? void 0 : dest.end();
            return yield tslib_1.__await(void 0);
        }
        dest === null || dest === void 0 ? void 0 : dest.write("\r\n]");
        dest === null || dest === void 0 ? void 0 : dest.end();
    });
}
function jsonWrite(data, out) {
    if (arguments.length === 1) {
        if (!(typeof data === 'string' || data instanceof events_1.EventEmitter)) {
            throw new Error("Impossible combination");
        }
        return (d) => {
            return base_1.IX.from(_jsonIterWriter(base_1.outputToWriteStream(data), d));
        };
    }
    if (typeof data === 'string' || data instanceof events_1.EventEmitter) {
        throw new Error("Impossible combination");
    }
    if (!out) {
        throw new Error("Expected to receive output parameter but got undefined");
    }
    return base_1.IX.from(_jsonIterWriter(base_1.outputToWriteStream(out), data));
}
exports.jsonWrite = jsonWrite;
